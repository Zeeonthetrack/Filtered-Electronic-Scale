/**
 *****************************************************************************************************
  * @copyright	(c)  Shenzhen Saiyuan Microelectronics Co., Ltd
  * @file	         main.c
  * @author	 
  * @version 	
  * @date	
  * @brief	         
  * @details         Contains the MCU initialization function and its H file
 *****************************************************************************************************
 * @attention
 *
 *****************************************************************************************************
 */
/*******************Includes************************************************************************/

#include "SC_Init.h"
#include "SC_it.h"
#include "..\Drivers\SCDriver_list.h"
#include "HeadFiles\SysFunVarDefine.h"
#include "sc32f12xx_TK_DynamicDebug.h"
#include <stdio.h>

/**************************************Generated by EasyCodeCube*************************************/
//Forbid editing areas between the labels !!!

/*************************************.Generated by EasyCodeCube.************************************/

uint32_t TK_exKeyValueFlag = 0; //当前轮按键标志
uint8_t exKeyValue = 0;
// 消抖相关变量
uint32_t lastKeyValue = 0;      // 上次按键值
uint32_t stableKeyValue = 0;    // 稳定按键值
uint8_t debounceCount = 0;      // 消抖计数器
uint8_t keyPressed = 0;         // 按键已确认按下标志

//函数声明
void Sys_Scan(void);
void ChangeTouchKeyvalue(void);
void DebounceTouchKey(void);    // 新增消抖函数

int main(void)
{

    IcResourceInit();
    TK_Init();
	PB_BIT(10)=0;
	PB_BIT(13)=0;
	PB_BIT(14)=0;
	PB_BIT(15)=0;
    while(1)
	{
		WDT->WDT_CON |= WDT_CON_CLRWDT;  //清watchdog
		if(TK_TouchKeyStatus&0x80)
		{	   													 //重要步骤3：清除标志位，需要外部清除
			TK_TouchKeyStatus &= 0x7f; 
				TK_exKeyValueFlag = TK_TouchKeyScan();  
				DebounceTouchKey();          // 先进行消抖处理
				if(keyPressed)
				{
					ChangeTouchKeyvalue();   // 按键数据处理函数
					if(exKeyValue==1)
					{
						PB_OT(10);
					}
					if(exKeyValue==2)
					{
						PB_OT(13);
					}
					if(exKeyValue==3)
					{
						PB_OT(14);
					}
					if(exKeyValue==4)
					{
						PB_OT(15);
					}
					keyPressed = 0;          // 清除按键标志
				}
				TK_Restart();	         //启动下一轮转换
		  }
		
		  
		  
		  
		  
	}
}

/**
  * @brief  触摸按键消抖处理
  * @param  None
  * @retval None
  */
void DebounceTouchKey(void)
{
    // 如果当前按键值与上次相同
    if(TK_exKeyValueFlag == lastKeyValue)
    {
        debounceCount++;
        
        // 连续5次检测到相同按键值，确认为有效按键
        if(debounceCount >= 5)
        {
            if(stableKeyValue != TK_exKeyValueFlag)
            {
                stableKeyValue = TK_exKeyValueFlag;
                keyPressed = 1;  // 设置按键按下标志
            }
            debounceCount = 5;   // 防止计数器溢出
        }
    }
    else
    {
        // 按键值变化，重置计数器
        debounceCount = 0;
        lastKeyValue = TK_exKeyValueFlag;
    }
    
    // 无按键时的处理（按键值为0）
    if(TK_exKeyValueFlag == 0)
    {
        debounceCount = 0;
        stableKeyValue = 0;
    }
}

/**
  * @brief  处理消抖后的按键值
  * @param  None
  * @retval None
  */
void ChangeTouchKeyvalue(void)
{
    switch(stableKeyValue)   // 使用消抖后的稳定值
    {        
        case 0x00000010:
            exKeyValue = 1;
            break;    
            
        case 0x00000020:
            exKeyValue = 2;
            break; 
            
        case 0x00000040:
            exKeyValue = 3;
            break;
            
        case 0x00000080:
            exKeyValue = 4;
            break;    
            
        default:
            exKeyValue = 0xff;
            break;             
    }
}

void Sys_Scan(void)
{	
    if(TK_TouchKeyStatus&0x80)	    //重要步骤2:  触摸键扫描一轮标志，是否调用TouchKeyScan()一定要根据此标志位置起后
    {	   																	
        TK_TouchKeyStatus &= 0x7f;	//重要步骤3: 清除标志位， 需要外部清除。													    
        TK_exKeyValueFlag = TK_TouchKeyScan();//按键数据处理函数 
        
        DebounceTouchKey();          // 消抖处理
        if(keyPressed) {
            ChangeTouchKeyvalue();
            keyPressed = 0;
        }
        
        TK_Restart();				//启动下一轮转换																														 			
    }
}